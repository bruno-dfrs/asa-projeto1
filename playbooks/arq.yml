---
- name: Apply exclusive configurations to the "arq" machine
  hosts: arq
  become: true

  vars:
    disks:
      - /dev/sdb
      - /dev/sdc
      - /dev/sdd

    vg_name: dados # Name of the LVM Volume Group

    lvs:
      - name: dados # Name of the LVM Logical Volume
        size: 15G # Size of the Logical Volume
        fstype: ext4
        mount: /dados # Mount point for the Logical Volume

    nfs_user: nfs-ifpb # System user for NFS ownership and squashing
    shared_dir: /dados/nfs # Directory to be exported via NFS
    subnet: 192.168.56.0/24 # Network allowed to access the NFS share

  tasks:
    ### ──────────────────────────────────────────────────────────────────
    ###                               DHCP
    ### ──────────────────────────────────────────────────────────────────

    # 1. Install the ISC DHCP Server package
    # This provides the Dynamic Host Configuration Protocol service to assign IPs on the private network.
    - name: Install ISC DHCP Server
      ansible.builtin.apt:
        name: isc-dhcp-server
        state: present

    # 2. Deploy the DHCP server configuration file
    # Copies a pre-configured dhcpd.conf file that defines the IP pool, lease times, and options for the network.
    - name: Deploy DHCP server configuration
      ansible.builtin.copy:
        src: ../files/dhcp/dhcpd.conf
        dest: /etc/dhcp/dhcpd.conf
      notify: restart isc-dhcp-server

    # 3. Set the network interface for DHCP service
    # Configures the DHCP server to listen and serve requests on the private network interface (eth1).
    - name: Configure DHCP server interface
      ansible.builtin.lineinfile:
        path: /etc/default/isc-dhcp-server
        regexp: "^INTERFACESv4="
        line: "INTERFACESv4='eth1'"
        state: present
      notify: restart isc-dhcp-server

    # 4. Ensure the DHCP service is running and enabled at boot
    - name: Ensure DHCP service is active and enabled
      ansible.builtin.systemd_service:
        name: isc-dhcp-server
        state: restarted # Using 'restarted' ensures a fresh start; consider 'started' for idempotence.
        enabled: yes

    ### ──────────────────────────────────────────────────────────────────
    ###                               DNS
    ### ──────────────────────────────────────────────────────────────────

    # 5. Install the BIND9 DNS server package
    # BIND9 provides DNS resolution services for the local network (e.g., for the .devops domain).
    - name: Install BIND9 DNS server
      ansible.builtin.apt:
        name: bind9
        state: present

    # 6. Deploy BIND9 global options configuration
    # Sets general DNS server parameters like listening interfaces, forwarders, and ACLs.
    - name: Deploy BIND9 options configuration
      ansible.builtin.copy:
        src: ../files/dns/named.conf.options
        dest: /etc/bind/named.conf.options
        owner: root
        group: bind
        mode: "0644"
      notify: restart bind9

    # 7. Deploy BIND9 local zones configuration
    # Defines the DNS zones (domains) for which this server is authoritative (e.g., bruno.icaro.devops).
    - name: Deploy BIND9 local zones configuration
      ansible.builtin.copy:
        src: ../files/dns/named.conf.internal-zones
        dest: /etc/bind/named.conf.local
        owner: root
        group: bind
        mode: "0644"
      notify: restart bind9

    # 8. Deploy forward lookup zone file
    # Contains the A records mapping hostnames to IP addresses within the primary domain.
    - name: Deploy forward lookup zone file
      ansible.builtin.copy:
        src: ../files/dns/bruno.icaro.devops.db
        dest: /etc/bind/bruno.icaro.devops.db
        owner: root
        group: bind
        mode: "0644"
      notify: restart bind9

    # 9. Deploy reverse lookup zone file
    # Contains the PTR records mapping IP addresses back to hostnames for the 192.168.56.0/24 subnet.
    - name: Deploy reverse lookup zone file
      ansible.builtin.copy:
        src: ../files/dns/56.168.192.db
        dest: /etc/bind/56.168.192.db
        owner: root
        group: bind
        mode: "0644"
      notify: restart bind9

    # 10. Ensure the DNS service is running and enabled at boot
    - name: Ensure DNS service is active and enabled
      ansible.builtin.systemd_service:
        name: bind9
        state: started
        enabled: yes

    # 11. Configure the machine to use itself as DNS server
    - name: Configure local DNS resolution
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 127.0.0.1
          nameserver 192.168.56.128
          domain bruno.icaro.devops
          search bruno.icaro.devops
        owner: root
        group: root
        mode: "0644"

    - name: Make /etc/resolv.conf immutable
      ansible.builtin.shell:
        cmd: chattr +i /etc/resolv.conf

    ### ──────────────────────────────────────────────────────────────────
    ###                               LVM
    ### ──────────────────────────────────────────────────────────────────

    # 12. Install LVM2 and partitioning tools
    # Installs the necessary packages to manage Logical Volume Manager (LVM) and disk partitions.
    - name: Install LVM and partitioning tools
      ansible.builtin.apt:
        name: lvm2
        state: present

    # 13. Create physical volumes from the specified disks
    # Initializes each disk in the 'disks' list as a Physical Volume (PV) for LVM.
    # The 'when' condition ensures idempotence by only creating PVs on disks not already part of the volume group.
    - name: Create physical volume
      community.general.lvm_pv:
        device: "{{ item }}"
      loop: "{{ disks }}"
      when: item not in ansible_lvm.vgs[vg_name].pvs|default([])

    # 14. Create a volume group containing the physical volumes
    - name: Create volume group
      community.general.lvg:
        vg: "{{ vg_name }}"
        pvs: "{{ disks }}"

    # 15. Create logical volumes within the volume group
    - name: Create logical volume
      community.general.lvol:
        lv: "{{ item.name }}"
        vg: "{{ vg_name }}"
        size: "{{ item.size }}"
      loop: "{{ lvs }}"

    # 16. Format the logical volumes with a filesystem
    - name: Create filesystem
      ansible.builtin.filesystem:
        fstype: "{{ item.fstype }}"
        dev: "/dev/{{ vg_name }}/{{ item.name }}"
      loop: "{{ lvs }}"

    # 17. Mount the logical volumes to their respective directories
    - name: Mount logical volume
      ansible.builtin.mount:
        path: "{{ item.mount }}"
        src: "/dev/{{ vg_name }}/{{ item.name }}"
        fstype: "{{ item.fstype }}"
        state: mounted
      loop: "{{ lvs }}"

    ### ──────────────────────────────────────────────────────────────────
    ###                           NFS & AutoFS
    ### ──────────────────────────────────────────────────────────────────

    # 18. Install the NFS kernel server package
    - name: Install NFS kernel server
      ansible.builtin.apt:
        name: nfs-kernel-server
        state: present

    # 19. Create the dedicated NFS system user
    # This user's UID/GID will be used for the 'all_squash' mapping. It has no login shell for security.
    # - name: Create dedicated NFS system user
    #   ansible.builtin.user:
    #     name: "{{ nfs_user }}"
    #     shell: /usr/sbin/nologin
    #     create_home: no
    #     system: yes
    #     state: present

    # 20. Create and configure the directory to be shared via NFS
    # Sets ownership and permissions. Using 0755 ensures the NFS user has full access and others can read/enter.
    - name: Create and configure NFS shared directory
      ansible.builtin.file:
        path: "{{ shared_dir }}"
        state: directory
        owner: "{{ nfs_user }}"
        group: "{{ nfs_user }}"
        mode: "0775"

    - name: Configure NFS export
      ansible.builtin.lineinfile:
        path: /etc/exports
        line: "{{ shared_dir }} {{ subnet }}(rw,sync,no_subtree_check,all_squash,anonuid=2001,anongid=2001)"
        insertafter: EOF
        create: yes # Creates the /etc/exports file if it doesn't exist
      notify: restart nfs-kernel-server

    # 25. Ensure the NFS service is running and enabled at boot
    - name: Ensure NFS service is active and enabled
      ansible.builtin.systemd_service:
        name: nfs-kernel-server
        state: started
        enabled: yes

  handlers:
    # Handler to restart the DHCP server if its configuration changed
    - name: restart isc-dhcp-server
      ansible.builtin.systemd_service:
        name: isc-dhcp-server
        state: restarted

    # Handler to restart the DNS server if its configuration changed
    - name: restart bind9
      ansible.builtin.systemd_service:
        name: bind9
        state: restarted

    # Handler to restart the NFS server if its configuration changed
    - name: restart nfs-kernel-server
      ansible.builtin.systemd_service:
        name: nfs-kernel-server
        state: restarted
