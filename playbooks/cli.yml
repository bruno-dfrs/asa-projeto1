---
- name: Apply exclusive configurations to the "cli" machine
  hosts: cli
  become: true

  vars:
    nfs_mount_point: /var/nfs # Local directory for NFS mount point
    remote_share: 192.168.56.128:/dados/nfs # Remote NFS share path (server IP:path)

  tasks:
    ### ──────────────────────────────────────────────────────────────────
    ###                               SSH
    ### ──────────────────────────────────────────────────────────────────

    # 1. Install packages required for graphical browser and X11 forwarding
    # Installs Firefox ESR browser and X11 utilities needed to display GUI applications over SSH.
    - name: Install GUI and X11 packages
      ansible.builtin.apt:
        name:
          - firefox-esr # Web browser with long-term support
          - xauth # Manages X11 authentication cookies for secure display forwarding
          - x11-utils # Basic X11 utilities (e.g., xdpyinfo, xrandr)
        state: present

    # 2. Configure SSH server to allow X11 Forwarding
    # Enables the SSH server to forward graphical (X11) applications from the VM to the host machine.
    - name: Enable X11 Forwarding in SSH
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?X11Forwarding"
        line: "X11Forwarding yes"
        state: present
      notify: restart ssh

    # 3. Set X11 Display Offset
    # Defines a display number offset to avoid conflicts with local displays on the host.
    - name: Set X11 display offset
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?X11DisplayOffset"
        line: "X11DisplayOffset 10"
        state: present
      notify: restart ssh

    # 4. Configure X11 to not bind only to localhost
    # Allows remote X11 clients (from the host) to connect, necessary for GUI over SSH.
    - name: Configure X11 to allow remote connections
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?X11UseLocalhost"
        line: "X11UseLocalhost no"
        state: present
      notify: restart ssh

    ### ──────────────────────────────────────────────────────────────────
    ###                           NFS & AutoFS
    ### ──────────────────────────────────────────────────────────────────

    # 5. Install the AutoFS service for automatic NFS mounting
    # AutoFS mounts the NFS share on-demand when accessed and unmounts after inactivity.
    - name: Install AutoFS for NFS
      ansible.builtin.apt:
        name: autofs
        state: present

    # 6. Configure the AutoFS master map file
    # Tells AutoFS to use the map file /etc/auto.nfs for mounts under {{ nfs_mount_point }}.
    # The '--ghost' option creates empty directories before mounting for better visibility.
    - name: Configure AutoFS master map
      ansible.builtin.lineinfile:
        path: /etc/auto.master
        line: "/- /etc/auto.nfs --ghost"
        insertafter: EOF
        create: yes # Creates the /etc/auto.master file if it doesn't exist
      notify: restart autofs

    # 7. Define the NFS share details in the AutoFS map file
    # Specifies the remote NFS server, mount options, and local subdirectory name ("nfs").
    # Options: rw (read-write), hard (retry indefinitely on server failure), timeo (timeout in deciseconds).
    - name: Configure NFS share in AutoFS map
      ansible.builtin.lineinfile:
        path: /etc/auto.nfs
        line: "{{ nfs_mount_point }} -fstype=nfs,rw,hard,intr,timeo=300 {{ remote_share }}"
        insertafter: EOF
        create: yes # Creates the /etc/auto.nfs file if it doesn't exist
      notify: restart autofs

    # 8. Ensure the AutoFS service is running and enabled at boot
    - name: Ensure AutoFS service is active
      ansible.builtin.systemd_service:
        name: autofs
        state: started
        enabled: yes

  handlers:
    # Handler to restart the SSH service if any SSH configuration changed
    - name: restart ssh
      ansible.builtin.systemd_service:
        name: ssh
        state: restarted

    # Handler to restart the AutoFS service if its configuration changed
    - name: restart autofs
      ansible.builtin.systemd_service:
        name: autofs
        state: restarted
