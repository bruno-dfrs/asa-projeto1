---
- name: Apply generic configurations to all machines (arq, db, app, cli)
  hosts: all
  become: true

  vars:
    users:
      - bruno
      - icaro

  tasks:
    ### ──────────────────────────────────────────────────────────────────
    ###                          System Update
    ### ──────────────────────────────────────────────────────────────────

    # 1. Update the APT package cache and upgrade all system packages
    # Performs a full system upgrade including automatic removal of obsolete packages.
    - name: Update system packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: full
        autoremove: yes

    ### ──────────────────────────────────────────────────────────────────
    ###                           Chrony (NTP)
    ### ──────────────────────────────────────────────────────────────────

    # 2. Install the Chrony package for time synchronization
    - name: Install Chrony
      ansible.builtin.apt:
        name: chrony
        state: present

    # 3. Configure Chrony to use the Brazilian NTP pool
    # Sets the NTP server pool to 'pool.ntp.br' with 'iburst' for faster initial synchronization.
    - name: Configure Chrony NTP server
      ansible.builtin.lineinfile:
        path: /etc/chrony/chrony.conf
        regexp: "^pool"
        line: "pool pool.ntp.br iburst"
      notify: restart chronyd

    # 4. Ensure Chrony service is running and enabled at boot
    - name: Ensure Chrony service is active and enabled
      ansible.builtin.systemd_service:
        name: chronyd
        state: started
        enabled: yes

    # 5. Set system timezone to America/Recife
    - name: Set timezone to America/Recife
      ansible.builtin.shell:
        cmd: timedatectl set-timezone "America/Recife"

    ### ──────────────────────────────────────────────────────────────────
    ###                         Groups and Users
    ### ──────────────────────────────────────────────────────────────────

    # 6. Create the 'ifpb' system group
    - name: Create 'ifpb' group
      ansible.builtin.group:
        name: ifpb
        state: present

    # 7. Grant sudo privileges to members of the 'ifpb' group
    # Adds a line to /etc/sudoers allowing all members of 'ifpb' group to execute any command.
    - name: Grant sudo privileges to 'ifpb' group
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        regexp: "%ifpb"
        line: "%ifpb ALL=(ALL:ALL) ALL"
        state: present

    # 8. Create users 'bruno' and 'icaro' with SSH keys and add them to 'ifpb' group
    # Creates each user with a hashed password, generates an SSH key pair, and adds them to the 'ifpb' group.
    - name: Create users with SSH keys and add to 'ifpb' group
      ansible.builtin.user:
        name: "{{ item }}"
        state: present
        password: "{{ 'ifpb' | password_hash('sha512') }}"
        groups: ifpb
        append: yes
        shell: /bin/bash
        generate_ssh_key: true
        ssh_key_file: .ssh/key_{{ item }}
      loop: "{{ users }}"

    # 9. Deploy the host's SSH public key to each user's authorized_keys
    # Enables passwordless SSH login from the Ansible control node to each VM user account.
    - name: Deploy host SSH public key to users
      ansible.posix.authorized_key:
        user: "{{ item }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
      loop: "{{ users }}"

    - name: Create 'nfs-ifpb' group
      ansible.builtin.group:
        name: nfs-ifpb
        state: present
        gid: "2001"

    - name: Create NFS user with consistent UID/GID across all VMs
      ansible.builtin.user:
        name: nfs-ifpb
        uid: "2001"
        group: nfs-ifpb
        system: yes
        create_home: no
        shell: /usr/sbin/nologin
        state: present

    ### ──────────────────────────────────────────────────────────────────
    ###                      SSH Server Configuration
    ### ──────────────────────────────────────────────────────────────────

    # 10. Enable public key authentication in SSH daemon
    - name: Enable SSH public key authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PubkeyAuthentication"
        line: "PubkeyAuthentication yes"
        state: present

    # 11. Disable password authentication in SSH daemon
    # Enforces key-based authentication only for enhanced security.
    - name: Disable SSH password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication no"
        state: present

    # 12. Disable direct root login via SSH
    - name: Disable SSH root login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PermitRootLogin"
        line: "PermitRootLogin no"
        state: present

    # 13. Restrict SSH access to members of 'vagrant' and 'ifpb' groups only
    - name: Restrict SSH access to specific groups
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        line: "AllowGroups vagrant ifpb"
        insertafter: EOF
        create: yes

    # 14. Create SSH banner warning message file
    - name: Create SSH banner file
      ansible.builtin.copy:
        content: "Acesso apenas para pessoas com autorização expressa!!!"
        dest: /etc/issue.net

    # 15. Configure SSH daemon to display the banner on login
    - name: Configure SSH banner
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?Banner"
        line: "Banner /etc/issue.net"
      notify: restart sshd

    ### ──────────────────────────────────────────────────────────────────
    ###                            NFS Client
    ### ──────────────────────────────────────────────────────────────────

    # 16. Install NFS common utilities (client-side)
    # Required for NFS mounting operations on client machines.
    - name: Install NFS client utilities
      ansible.builtin.apt:
        name: nfs-common
        state: present

  handlers:
    # Handler to restart Chrony service if its configuration changed
    - name: restart chronyd
      ansible.builtin.systemd_service:
        name: chronyd
        state: restarted

    # Handler to restart SSH service if its configuration changed
    - name: restart sshd
      ansible.builtin.systemd_service:
        name: sshd
        state: restarted
